services:
  #############################
  ## ADGUARD - ROOT
  #############################

  adguard:
    image: adguard/adguardhome:latest
    container_name: adguardhome
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.docker.network=adguard-net
      - traefik.http.services.adguard-svc.loadbalancer.server.port=80
      - traefik.http.routers.adguard-rtr.rule=Host(`adguard.${DNS_DOMAIN}`)
      - traefik.http.routers.adguard-rtr.entrypoints=websecure
      - traefik.http.routers.adguard-rtr.tls=true
      - traefik.http.routers.adguard-rtr.middlewares=ipwhitelist-mddl@docker
    networks:
      - adguard-net
    ports:
      - "53:53/udp"
      - "53:53/tcp"
    volumes:
      - "${LOCAL_MOUNT}/adguard/data:/opt/adguardhome/work"
      - "${LOCAL_MOUNT}/adguard/conf:/opt/adguardhome/conf"
    dns: "1.1.1.1"

  #############################
  ## BACKREST
  #############################

  backrest:
    image: garethgeorge/backrest:v1.9
    user: ${PUID:-1000}
    container_name: backrest
    restart: unless-stopped
    networks:
      - backrest-net
    labels:
      - traefik.enable=true
      - traefik.docker.network=backrest-net
      - traefik.http.services.backrest-svc.loadbalancer.server.port=9898
      - traefik.http.routers.backrest-rtr.rule=Host(`backrest.${DNS_DOMAIN}`)
      - traefik.http.routers.backrest-rtr.entrypoints=websecure
      - traefik.http.routers.backrest-rtr.tls=true
      - traefik.http.routers.backrest-rtr.middlewares=ipwhitelist-mddl@docker,traefik-forward-auth@docker
    volumes:
      - ${SECONDARY_MOUNT}/backrest/data:/data
      - ${SECONDARY_MOUNT}/backrest/config:/config
      - ${SECONDARY_MOUNT}/backrest/cache:/cache
      - ${PRIMARY_MOUNT}:/sources/primary
      - ${LOCAL_MOUNT}:/sources/local
      - ${SECONDARY_MOUNT}/backrest/repos:/repos # [optional] mount repos if using local storage, not necessary for remotes e.g. B2, S3, etc.
    environment:
      - BACKREST_DATA=/data # path for backrest data. restic binary and the database are placed here.
      - BACKREST_CONFIG=/config/config.json # path for the backrest config file.
      - XDG_CACHE_HOME=/cache # path for the restic cache which greatly improves performance.
      - TZ=${TIME_ZONE}
      - "PUID=${PUID:-1000}"
      - "PGID=${PUID:-1000}"

  #############################
  ## ARRS
  #############################

  prowlarr:
    image: ghcr.io/linuxserver/prowlarr:develop
    container_name: prowlarr
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PUID:-1000}
      - TZ=${TIME_ZONE}
    volumes:
      - ${PRIMARY_MOUNT}/prowlarr/config:/config
    labels:
      - traefik.enable=true
      - traefik.docker.network=arr-net
      - traefik.http.services.prowlarr-svc.loadbalancer.server.port=9696
      - traefik.http.routers.prowlarr-rtr.rule=Host(`prowlarr.${DNS_DOMAIN}`)
      - traefik.http.routers.prowlarr-rtr.entrypoints=websecure
      - traefik.http.routers.prowlarr-rtr.tls=true
      - traefik.http.routers.prowlarr-rtr.middlewares=ipwhitelist-mddl@docker,traefik-forward-auth@docker
    restart: unless-stopped
    networks:
      - arr-net

  radarr:
    image: ghcr.io/linuxserver/radarr:latest
    container_name: radarr
    restart: unless-stopped
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PUID:-1000}
      - TZ=${TIME_ZONE}
    labels:
      - traefik.enable=true
      - traefik.docker.network=arr-net
      - traefik.http.services.radarr-svc.loadbalancer.server.port=7878
      - traefik.http.routers.radarr-rtr.rule=Host(`radarr.${DNS_DOMAIN}`)
      - traefik.http.routers.radarr-rtr.entrypoints=websecure
      - traefik.http.routers.radarr-rtr.tls=true
      - traefik.http.routers.radarr-rtr.middlewares=ipwhitelist-mddl@docker
    volumes:
      - ${PRIMARY_MOUNT}/radarr/data:/config
      - ${MEDIA_MOUNT}/plex/media/:/data
    networks:
      - arr-net

  sonarr:
    image: ghcr.io/linuxserver/sonarr
    container_name: sonarr
    restart: unless-stopped
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PUID:-1000}
      - TZ=${TIME_ZONE}
    labels:
      - traefik.enable=true
      - traefik.docker.network=arr-net
      - traefik.http.services.sonarr-svc.loadbalancer.server.port=8989
      - traefik.http.routers.sonarr-rtr.rule=Host(`sonarr.${DNS_DOMAIN}`)
      - traefik.http.routers.sonarr-rtr.entrypoints=websecure
      - traefik.http.routers.sonarr-rtr.tls=true
      - traefik.http.routers.sonarr-rtr.middlewares=ipwhitelist-mddl@docker
    volumes:
      - ${PRIMARY_MOUNT}/sonarr/data:/config
      - ${MEDIA_MOUNT}/plex/media/:/data
    networks:
      - arr-net

  #############################
  ## CALIBRE
  #############################

  calibre_web:
    image: ghcr.io/linuxserver/calibre-web:latest
    container_name: calibre_web
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.docker.network=calibre-net
      - traefik.http.services.calibre-svc.loadbalancer.server.port=8083
      - traefik.http.routers.calibre-rtr.rule=Host(`calibre.${DNS_DOMAIN}`)
      - traefik.http.routers.calibre-rtr.entrypoints=websecure
      - traefik.http.routers.calibre-rtr.tls=true
      - traefik.http.routers.calibre-rtr.middlewares=traefik-forward-auth@docker
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PUID:-1000}
      - "TZ=${TIME_ZONE}"
      - "DOCKER_MODS=linuxserver/calibre-web:calibre"
    volumes:
      - ${PRIMARY_MOUNT}/calibre/config:/config
      - ${PRIMARY_MOUNT}/calibre/books:/books
    networks:
      - calibre-net

  #############################
  ## CHANGEDETECTION
  #############################

  changedetection:
    image: ghcr.io/dgtlmoon/changedetection.io
    container_name: changedetection
    restart: unless-stopped
    volumes:
      - ${SECONDARY_MOUNT}/changedetection/datastore:/datastore
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PUID:-1000}
      - WEBDRIVER_URL="http://changedetection-selenium:4444/wd/hub"
    labels:
      - traefik.enable=true
      - traefik.docker.network=changedetection-net
      - traefik.http.services.changedetection-svc.loadbalancer.server.port=5000
      - traefik.http.routers.changedetection-rtr.rule=Host(`changedetection.${DNS_DOMAIN}`)
      - traefik.http.routers.changedetection-rtr.entrypoints=websecure
      - traefik.http.routers.changedetection-rtr.tls=true
    networks:
      - changedetection-net

  #############################
  ## CLOUDFLARE - ROOT
  #############################

  cloudflare:
    image: oznu/cloudflare-ddns:latest
    restart: unless-stopped
    container_name: cloudflare
    labels:
      - traefik.enable=false
    environment:
      - "API_KEY=${CF_TOKEN}"
      - "ZONE=${DNS_DOMAIN}"
      - "SUBDOMAIN=${SUBDOMAIN}"
      - "DNS_SERVER=1.0.0.1"
    dns: 1.1.1.1

  #############################
  ## CLOUDFLARE-COMPANION - ROOT
  #############################

  cloudflare-companion:
    image: tiredofit/traefik-cloudflare-companion
    container_name: cloudflare-companion
    restart: unless-stopped
    volumes:
      - ${SOCK_PATH:-/var/run/docker.sock}:/var/run/docker.sock
    environment:
      - "TRAEFIK_VERSION=2"
      # - "CF_EMAIL=" Leave blank for scopepd
      - "CF_TOKEN=${CF_TOKEN}"
      - "TARGET_DOMAIN=${SUBDOMAIN}.${DNS_DOMAIN}"
      - "DOMAIN1=${DNS_DOMAIN}"
      - "DOMAIN1_ZONE_ID=${DNS_DOMAIN_ZONE_ID}"
    dns: 1.1.1.1


  #############################
  ## DOZZLE - ROOT
  #############################

  dozzle:
    container_name: dozzle
    image: amir20/dozzle:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - dozzle-net
    environment:
      DOZZLE_ENABLE_SHELL: true
      DOZZLE_ENABLE_ACTIONS: true
    labels:
      - traefik.enable=true
      - traefik.docker.network=dozzle-net
      - traefik.http.services.dozzle-svc.loadbalancer.server.port=8080
      - traefik.http.routers.dozzle-rtr.rule=Host(`dozzle.${DNS_DOMAIN}`)
      - traefik.http.routers.dozzle-rtr.entrypoints=websecure
      - traefik.http.routers.dozzle-rtr.tls=true
      - traefik.http.routers.dozzle-rtr.middlewares=traefik-forward-auth@docker,ipwhitelist-mddl@docker

  #############################
  ## DRONE CI - ROOT
  #############################

  drone:
    image: drone/drone:1
    restart: unless-stopped
    container_name: drone
    user: ${PUID:-1000}
    labels:
      - traefik.enable=true
      - traefik.docker.network=drone-net
      - traefik.http.services.drone-svc.loadbalancer.server.port=80
      - traefik.http.routers.drone-rtr.rule=Host(`drone.${DNS_DOMAIN}`)
      - traefik.http.routers.drone-rtr.entrypoints=websecure
      - traefik.http.routers.drone-rtr.tls=true
    environment:
      - DRONE_GITHUB_CLIENT_ID=${DRONE_GITHUB_CLIENT_ID}
      - DRONE_GITHUB_CLIENT_SECRET=${DRONE_GITHUB_CLIENT_SECRET}
      - DRONE_RPC_SECRET=${DRONE_RPC_SECRET}
      - DRONE_SERVER_HOST=drone.${DNS_DOMAIN}
      - DRONE_SERVER_PROTO=https
      - DRONE_USER_CREATE=${DRONE_USER_CREATE}
      - DRONE_USER_FILTER=${DRONE_USER_FILTER}
    volumes:
      - ${PRIMARY_MOUNT}/drone/server/data:/data
    networks:
      - drone-net
      - drone-private-net

  drone-runner:
    image: drone/drone-runner-docker:1
    restart: unless-stopped
    container_name: drone_runner_1
    environment:
      - DRONE_RPC_PROTO=http
      - DRONE_RPC_HOST=drone
      - DRONE_RPC_SECRET=${DRONE_RPC_SECRET}
      - DRONE_RUNNER_CAPACITY=2
      - DRONE_RUNNER_NAME=drone-runner-1
    labels: 
      - traefik.enable=false
    volumes:
      - ${SOCK_PATH:-/var/run/docker.sock}:/var/run/docker.sock
    networks:
      - drone-private-net

  #############################
  ## JELLYFIN
  #############################

  jellyfin:
    image: lscr.io/linuxserver/jellyfin
    container_name: jellyfin
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.docker.network=plex-net
      - traefik.http.services.jellyfin-svc.loadbalancer.server.port=8096
      - traefik.http.routers.jellyfin-rtr.rule=Host(`jellyfin.${DNS_DOMAIN}`)
      - traefik.http.routers.jellyfin-rtr.entrypoints=websecure
      - traefik.http.routers.jellyfin-rtr.tls=true
    environment:
      - "TZ=${TIME_ZONE}"
      - "PUID=${PUID:-1000}"
      - "PGID=${PUID:-1000}"
      - "JELLYFIN_PublishedServerUrl=jellyfin.${DNS_DOMAIN}"
    volumes:
      - ${PRIMARY_MOUNT}/jellyfin/config:/config
      - ${MEDIA_MOUNT}/plex/media:/data
    devices:
      - /dev/dri:/dev/dri
    networks:
      - plex-net

  #############################
  ## MINIFLUX
  #############################

  miniflux_postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    container_name: miniflux_postgres
    volumes:
      - ${PRIMARY_MOUNT}/miniflux_postgres_15:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: miniflux
      POSTGRES_USER: miniflux
      POSTGRES_PASSWORD: miniflux
    networks:
      - miniflux-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5

  miniflux:
    image: ghcr.io/miniflux/miniflux:latest
    container_name: miniflux
    restart: unless-stopped
    depends_on:
      miniflux_postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "/usr/bin/miniflux", "-healthcheck", "auto"]
      interval: 10s
      timeout: 5s
      retries: 5
    environment:
      - "BASE_URL=https://miniflux.${DNS_DOMAIN}"
      - "DATABASE_URL=postgres://miniflux:miniflux@miniflux_postgres/miniflux?sslmode=disable"
      - RUN_MIGRATIONS=1
      - CREATE_ADMIN=1
      - ADMIN_USERNAME=admin
      - ADMIN_PASSWORD=miniflux
    volumes:
      - ${PRIMARY_MOUNT}/miniflux/config:/config
    labels:
      - traefik.enable=true
      - traefik.docker.network=miniflux-net
      - traefik.http.services.miniflux-svc.loadbalancer.server.port=8080
      - traefik.http.routers.miniflux-rtr.rule=Host(`miniflux.${DNS_DOMAIN}`)
      - traefik.http.routers.miniflux-rtr.entrypoints=websecure
      - traefik.http.routers.miniflux-rtr.tls=true
    networks:
      - miniflux-net

  #############################
  ## KOBODL
  #############################

  navidrome:
    image: deluan/navidrome:latest
    container_name: navidrome
    user: ${PUID:-1000}:${PGID:-1000}
    restart: unless-stopped
    networks:
      - navidrome-net
    environment:
      # Optional: put your config options customization here. Examples:
      ND_LOGLEVEL: debug
    volumes:
      - "${PRIMARY_MOUNT}/navidrome/data:/data"
      - "${PRIMARY_MOUNT}/data/music:/music:ro"
    labels:
      - traefik.enable=true
      - traefik.docker.network=navidrome-net
      - traefik.http.services.navidrome-svc.loadbalancer.server.port=4533
      - traefik.http.routers.navidrome-rtr.rule=Host(`music.${DNS_DOMAIN}`)
      - traefik.http.routers.navidrome-rtr.entrypoints=websecure
      - traefik.http.routers.navidrome-rtr.tls=true
      - traefik.http.routers.navidrome-rtr.middlewares=traefik-forward-auth@docker

  #############################
  ## KOBODL
  #############################

  kobodl:
    image: ghcr.io/subdavis/kobodl:latest
    container_name: kobodl
    restart: unless-stopped
    user: ${PUID:-1000}
    labels:
      - traefik.enable=true
      - traefik.docker.network=kobodl-net
      - traefik.http.services.kobodl-svc.loadbalancer.server.port=5000
      - traefik.http.routers.kobodl-rtr.rule=Host(`kobodl.${DNS_DOMAIN}`)
      - traefik.http.routers.kobodl-rtr.entrypoints=websecure
      - traefik.http.routers.kobodl-rtr.tls=true
      - traefik.http.routers.kobodl-rtr.middlewares=traefik-forward-auth@docker
    volumes:
      - ${PRIMARY_MOUNT}/kobodl/kobodl.json:/home/kobodl.json
      - ${PRIMARY_MOUNT}/kobodl/downloads:/home/downloads
    command: --config /home/kobodl.json serve -h 0.0.0.0 --output-dir /home/downloads
    networks:
      - kobodl-net

  #############################
  ## RSS-Glue
  #############################

  rssglue:
    image: ghcr.io/subdavis/rss-glue
    container_name: rssglue
    restart: unless-stopped
    tty: true
    labels:
      - traefik.enable=false
    environment:
      - ANTHROPIC_KEY=${ANTHROPIC_KEY}
      - INSTA_SC_API_KEY=${INSTA_SC_API_KEY}
      - TZ=${TIME_ZONE}
      - PYTHONUNBUFFERED=1
    volumes:
      - ${PRIMARY_MOUNT}/rss-glue/static:/opt/rssglue/src/static
      - "./etc/rss-glue/config.py:/opt/rssglue/config.py:ro"
    command: ["--config", "/opt/rssglue/config.py", "watch"]
    
  # Nginx service serves the static files from the rssglue_static volume
  rssglue_nginx:
    image: dceoy/nginx-autoindex
    container_name: rssglue_nginx
    restart: unless-stopped
    volumes:
      -  ${PRIMARY_MOUNT}/rss-glue/static:/var/lib/nginx/html:ro
    labels:
      - traefik.enable=true
      - traefik.docker.network=rss-glue-net
      - traefik.http.services.rssglue-svc.loadbalancer.server.port=80
      - traefik.http.routers.rssglue-rtr.rule=Host(`rssglue.${DNS_DOMAIN}`)
      - traefik.http.routers.rssglue-rtr.entrypoints=websecure
      - traefik.http.routers.rssglue-rtr.tls=true
    networks:
      - rss-glue-net


  #############################
  ## SonarQube Enterprise
  #############################

  # sonarqube:
  #   image: sonarqube:2025.4-enterprise
  #   container_name: sonarqube
  #   restart: unless-stopped
  #   volumes:
  #     - ${SECONDARY_MOUNT}/sonarqube/data:/opt/sonarqube/data
  #     - ${SECONDARY_MOUNT}/sonarqube/logs:/opt/sonarqube/logs
  #     - ${SECONDARY_MOUNT}/sonarqube/extensions:/opt/sonarqube/extensions
  #   networks:
  #     - sonarqube-net
  #   labels:
  #     - traefik.enable=true
  #     - traefik.docker.network=sonarqube-net
  #     - traefik.http.services.sonarqube-svc.loadbalancer.server.port=9000
  #     - traefik.http.routers.sonarqube-rtr.rule=Host(`sonar.${DNS_DOMAIN}`)
  #     - traefik.http.routers.sonarqube-rtr.entrypoints=websecure
  #     - traefik.http.routers.sonarqube-rtr.tls=true
  #     - traefik.http.routers.sonarqube-rtr.middlewares=ipwhitelist-mddl@docker

  #############################
  ## TRANSMISSION_TORRENT
  #############################

  transmission:
    image: haugene/transmission-openvpn:4
    container_name: transmission
    restart: unless-stopped
    labels: 
      - "com.centurylinklabs.watchtower.enable=false"
      - traefik.enable=true
      - traefik.docker.network=transmission-net
      - traefik.http.services.transmission-svc.loadbalancer.server.port=9091
      - traefik.http.routers.transmission-rtr.rule=Host(`torrent.${DNS_DOMAIN}`)
      - traefik.http.routers.transmission-rtr.entrypoints=websecure
      - traefik.http.routers.transmission-rtr.tls=true
      - traefik.http.routers.transmission-rtr.middlewares=traefik-forward-auth@docker,ipwhitelist-mddl@docker
    networks:
      - arr-net
      - transmission-net
    dns: 1.1.1.1
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
    mem_limit: 512m
    mem_reservation: 256m
    cap_add:
      - NET_ADMIN
    volumes:  
      - ${MEDIA_MOUNT}/plex/media/:/data
      - /etc/localtime:/etc/localtime:ro
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PUID:-1000}
      - "OPENVPN_CONFIG=${OPENVPN_CONFIG}"
      - "OPENVPN_PROVIDER=${OPENVPN_PROVIDER}"
      - "OPENVPN_USERNAME=${TORRENT_USERNAME}"
      - "OPENVPN_PASSWORD=${TORRENT_PASSWORD}"
      - "OPENVPN_OPTS=--inactive 3600 --ping 10 --ping-exit 60"
      - "LOCAL_NETWORK=${LOCAL_NETWORK}"
      - "PIA_OPENVPN_CONFIG_BUNDLE=openvpn-tcp"

  #############################
  ## TRAEFIK - ROOT
  #############################

  traefik:
    image: traefik:v2.4
    restart: unless-stopped
    container_name: traefik
    command: >
      --api.insecure=true
      --serversTransport.insecureSkipVerify=true
      --accesslog=true
      --accesslog.filepath=/var/log/traefik/access.log
      --accesslog.fields.headers.names.Content-Type=keep
      --accesslog.fields.headers.names.Referer=keep
      --accesslog.fields.headers.names.User-Agent=keep
      --providers.docker=true
      --providers.docker.exposedByDefault=false
      --entrypoints.web.address=:80
      --entrypoints.websecure.address=:443
      --entrypoints.websecure.forwardedHeaders.trustedIPs=173.245.48.0/20,103.21.244.0/22,103.22.200.0/22,103.31.4.0/22,141.101.64.0/18,108.162.192.0/18,190.93.240.0/20,188.114.96.0/20,197.234.240.0/22,198.41.128.0/17,162.158.0.0/15,104.16.0.0/12,172.64.0.0/13,131.0.72.0/22
      --entrypoints.websecure.http.tls.certresolver=myresolver
      --entrypoints.websecure.http.tls.domains[0].main=*.${DNS_DOMAIN}
      --entrypoints.websecure.http.tls.domains[0].sans=${DNS_DOMAIN}
      --certificatesResolvers.myresolver.acme.caServer="https://acme-v02.api.letsencrypt.org/directory"
      --certificatesresolvers.myresolver.acme.dnschallenge=true
      --certificatesresolvers.myresolver.acme.dnschallenge.provider=cloudflare
      --certificatesresolvers.myresolver.acme.email="${LETSENCRYPT_EMAIL}"
      --certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json
      --certificatesresolvers.myresolver.acme.dnschallenge.resolvers==1.1.1.1:53,1.0.0.1:53
    labels:
      - "traefik.enable=true"
      # Traefik HTTPS Redirect
      - "traefik.http.routers.http-catchall.entrypoints=web"
      - "traefik.http.routers.http-catchall.rule=HostRegexp(`{host:.+}`)"
      - "traefik.http.routers.http-catchall.middlewares=redirect-to-https-mddl@docker"
      - "traefik.http.middlewares.redirect-to-https-mddl.redirectscheme.scheme=https"
      # Other middlewares
      - "traefik.http.middlewares.ipwhitelist-mddl.ipwhitelist.sourcerange=127.0.0.1/32,${SUBNET}"
      - "traefik.http.middlewares.traefik-forward-auth.forwardauth.address=http://auth:4181"
      - "traefik.http.middlewares.traefik-forward-auth.forwardauth.authResponseHeaders=X-Forwarded-User"
      # For Vaultwarden
      - "traefik.http.middlewares.bw-stripPrefix.stripprefix.prefixes=/notifications/hub"
      - "traefik.http.middlewares.bw-stripPrefix.stripprefix.forceSlash=false"
      # Traefik Dashboard config
      - traefik.http.services.traefik-svc.loadbalancer.server.port=8080
      - traefik.http.routers.traefik-rtr.rule=Host(`traefik.${DNS_DOMAIN}`)
      - traefik.http.routers.traefik-rtr.entrypoints=websecure
      - traefik.http.routers.traefik-rtr.tls=true
      - traefik.http.routers.traefik-rtr.middlewares=traefik-forward-auth@docker
    environment:
      - CF_API_EMAIL=${CF_EMAIL}
      - CF_DNS_API_TOKEN=${CF_TOKEN}
      - CF_ZONE_API_TOKEN=${CF_TOKEN}
    volumes:
      - ${SOCK_PATH:-/var/run/docker.sock}:/var/run/docker.sock
      - "${LOCAL_MOUNT}/traefik/letsencrypt:/letsencrypt"
      - "${LOCAL_MOUNT}/traefik/logs:/var/log/traefik"
      - "./etc/traefik:/etc/traefik"
    ports:
      - "80:80"
      - "443:443"
    networks:
      - traefik-net
      - adguard-net
      - arr-net
      - auth-net
      - backrest-net
      - calibre-net
      - changedetection-net
      - dozzle-net
      - drone-net
      - miniflux-net
      - navidrome-net
      - kobodl-net
      - plex-net
      - rss-glue-net
      - transmission-net
      - umami-net
      - unifi-net
      - vaultwarden-net
      - zerobyte-net
     
  traefik-forward-auth:
    image: thomseddon/traefik-forward-auth:latest
    container_name: auth
    restart: unless-stopped
    user: ${PUID:-1000}
    networks:
      - auth-net
    environment:
      - "PROVIDERS_GOOGLE_CLIENT_ID=${AUTH_PROVIDERS_GOOGLE_CLIENT_ID}"
      - "PROVIDERS_GOOGLE_CLIENT_SECRET=${AUTH_PROVIDERS_GOOGLE_CLIENT_SECRET}"
      - "SECRET=${AUTH_SECRET}"
      - "WHITELIST=${AUTH_WHITELIST}"
    command: >
      --cookie-domain="${DNS_DOMAIN}"
      --auth-host="auth.${DNS_DOMAIN}"
      --config=/etc/authconfig.ini
    volumes:
      - "./etc/authconfig.ini:/etc/authconfig.ini:ro"
    labels:
      - traefik.enable=true
      - traefik.docker.network=auth-net
      - traefik.http.services.traefik-forward-auth-svc.loadbalancer.server.port=4181
      - traefik.http.routers.auth-rtr.rule=Host(`auth.${DNS_DOMAIN}`)
      - traefik.http.routers.auth-rtr.entrypoints=websecure
      - traefik.http.routers.auth-rtr.tls=true
      - traefik.http.routers.auth-rtr.middlewares=traefik-forward-auth

  #############################
  ## Umami
  #############################

  umami_postgres:
    image: postgres:15-alpine
    restart: always
    container_name: umami_postgres
    volumes:
      - ${PRIMARY_MOUNT}/postgres_15:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: umami
      POSTGRES_USER: umami
      POSTGRES_PASSWORD: umami
    networks:
      - umami-private-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5
  
  umami:
    image: ghcr.io/umami-software/umami:postgresql-latest
    restart: always
    container_name: umami
    # user: ${PUID:-1000} # Permissions error after recent change
    depends_on:
      umami_postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://umami:umami@umami_postgres:5432/umami
      DATABASE_TYPE: postgresql
      APP_SECRET: ${DNS_DOMAIN_ZONE_ID}
    labels:
      - traefik.enable=true
      - traefik.docker.network=umami-net
      - traefik.http.services.umami-svc.loadbalancer.server.port=3000
      - traefik.http.routers.umami-rtr.rule=Host(`umami.${DNS_DOMAIN}`)
      - traefik.http.routers.umami-rtr.entrypoints=websecure
      - traefik.http.routers.umami-rtr.tls=true
    networks:
      - umami-net
      - umami-private-net
    healthcheck:
      test: ["CMD-SHELL", "curl http://localhost:3000/api/heartbeat"]
      interval: 5s
      timeout: 5s
      retries: 5

  #############################
  ## VAULTWARDEN
  #############################

  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    restart: always
    user: ${PUID:-1000}
    volumes:
      - "${PRIMARY_MOUNT}/vaultwarden/data/:/data"
    environment:
      - WEBSOCKET_ENABLED=true
    networks:
      - vaultwarden-net
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=vaultwarden-net"
      # Entry Point for https
      - "traefik.http.routers.vaultwarden-rtr.entrypoints=websecure"
      - "traefik.http.routers.vaultwarden-rtr.rule=Host(`vaultwarden.${DNS_DOMAIN}`)"
      - "traefik.http.routers.vaultwarden-rtr.service=vaultwarden-svc"
      - "traefik.http.services.vaultwarden-svc.loadbalancer.server.port=80"
      # websocket
      - "traefik.http.routers.vaultwarden-ws-rtr.entrypoints=websecure"
      - "traefik.http.routers.vaultwarden-ws-rtr.rule=Host(`vaultwarden.${DNS_DOMAIN}`) && Path(`/notifications/hub`)"
      - "traefik.http.middlewares.vaultwarden-ws-rtr=bw-stripPrefix@file"
      - "traefik.http.routers.vaultwarden-ws-rtr.service=vaultwarden-ws-svc"
      - "traefik.http.services.vaultwarden-ws-svc.loadbalancer.server.port=3012"

  #############################
  ## WATCHTOWER - ROOT
  #############################

  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    command: --schedule "0 10 3 * * *" --cleanup
    labels:
      - traefik.enable=false
    volumes:
      - ${SOCK_PATH:-/var/run/docker.sock}:/var/run/docker.sock
      - "${PRIMARY_MOUNT}/watchtower/config/:/config"
      - "${PRIMARY_MOUNT}/watchtower/docker-config.json:/config.json"

  #############################
  ## ZeroByte Root
  #############################

  # zerobyte:
  #   image: ghcr.io/nicotsx/zerobyte:v0.13
  #   container_name: zerobyte
  #   restart: unless-stopped
  #   cap_add:
  #     - SYS_ADMIN
  #   devices:
  #     - /dev/fuse:/dev/fuse
  #   networks:
  #     - zerobyte-net
  #   environment:
  #     - TZ=${TIME_ZONE}  # Set your timezone here
  #   volumes:
  #     - /etc/localtime:/etc/localtime:ro
  #     - ${SECONDARY_MOUNT}/zerobyte:/var/lib/zerobyte
  #     # [optional] mount repos if using local storage, not necessary for remotes e.g. B2, S3, etc.
  #     - ${SECONDARY_MOUNT}/backrest/repos:/repos
  #     # User data mounts
  #     - ${PRIMARY_MOUNT}:/sources/primary
  #     - ${LOCAL_MOUNT}:/sources/local
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.docker.network=zerobyte-net"
  #     # Entry Point for https
  #     - "traefik.http.routers.zerobyte-rtr.entrypoints=websecure"
  #     - "traefik.http.routers.zerobyte-rtr.rule=Host(`zerobyte.${DNS_DOMAIN}`)"
  #     - "traefik.http.routers.zerobyte-rtr.service=zerobyte-svc"
  #     - "traefik.http.services.zerobyte-svc.loadbalancer.server.port=4096"

networks:
  adguard-net:
    name: adguard-net
  arr-net:
    name: arr-net
  backrest-net:
    name: backrest-net
  auth-net:
    name: auth-net
  calibre-net:
    name: calibre-net
  changedetection-net:
    name: changedetection-net
  dozzle-net:
    name: dozzle-net
  drone-net:
    name: drone-net
  drone-private-net:
    name: drone-private-net
  miniflux-net:
    name: miniflux-net
  navidrome-net:
    name: navidrome-net
  rss-glue-net:
    name: rss-glue-net
  kobodl-net:
    name: kobodl-net
  plex-net:
    name: plex-net
  transmission-net:
    name: transmission-net
  traefik-net:
    name: traefik-net
  umami-net:
    name: umami-net
  umami-private-net:
    name: umami-private-net
  unifi-net:
    name: unifi-net
  vaultwarden-net:
    name: vaultwarden-net
  zerobyte-net:
    name: zerobyte-net

volumes:
  redis-data:
